# メルカリShops バリエーション取得改善の技術メモ

## 課題
メルカリShopsの商品ページ構造は通常のメルカリと異なり、サイズや色の選択肢が `<button>` タグなどの明確な選択式UI要素として実装されていないケースが多々ありました。
既存のロジックは「ボタン」や「特定のクラス名」を探すアプローチだったため、単なるテキストのリストとして表現されているShopsのバリエーション（例：「カラー: ホワイト」「種類: 120cm」）を認識できず、データ取得に失敗していました。

## 解決の決定打（ブレイクスルー）
**「ラベル（見出し）を基準にした相対的な位置検索」** への転換が最大の要因です。

### アプローチの核心
従来の「特定のタグを探す」方法をやめ、「**人間が画面を見るのと同じ視点**」をプログラムで再現しました。
1. **見出しを見つける**: 「カラー」「種類」といった文字を探す。
2. **その隣を見る**: 見出しの直下（または隣）にあるエリアを特定する。
3. **中身を読み取る**: そこにある文字をすべて洗い出す。

このロジックにより、HTMLのタグが `div` であろうが `span` であろうが、あるいはクラス名が変わろうが、「見出しの隣にあるのが選択肢である」という構造が変わらない限り対応できるようになりました。

## 実装内容（技術詳細）

### 1. 兄弟要素の解析 (Sibling Container Analysis)
SeleniumとXPath、およびJavaScriptを組み合わせた探索を行いました。

- **STEP 1**: XPath `//*[contains(text(), '種類')]` でラベル要素を特定。
- **STEP 2**: その親要素に上がり、`nextElementSibling`（次の兄弟要素）を取得。これが「選択肢が入っている箱（コンテナ）」です。
- **STEP 3**: 箱の中に入っている直下の子要素をすべて取得し、そのテキストを抽出。

### 2. テキストクリーニング (Regex / 正規表現)
ここがもう一つの重要ポイントです。取得した生のテキストには、以下のように余計な情報が含まれていました。
> 生データ例: `120cm 残り1点 ¥2,682`

これでは「120cm」としてデータベースに保存できません。そこで正規表現（Regex）を導入し、ノイズを徹底的に除去しました。

```python
# Pythonでの実装イメージ
val = raw_text.split('\n')[0].strip()   # 改行より前だけを取る
val = re.sub(r'[¥￥]\s*[\d,]+', '', val) # 価格（¥2,682）を消す
val = re.sub(r'残り\d+点', '', val)      # 在庫情報（残り1点）を消す
val = re.sub(r'売り切れ', '', val)       # ステータス文字を消す
```

**結果**: `120cm` という純粋な値だけを取り出すことに成功しました。

## まとめ
- **決定打**: 「ボタン検索」から「見出し起点の相対位置検索」へのシフト。
- **技術的要点**: 兄弟要素（Sibling）のトラバース処理と、正規表現によるデータの正規化。

この知見は、メルカリに限らず、DOM構造が複雑または頻繁に変更されるECサイト（Amazon, 楽天など）のスクレイピングにおいも極めて有効な汎用テクニックとなります。
