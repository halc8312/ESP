# セキュリティ分析レポート

## 対象と目的
本レポートは、リポジトリ内のFlaskアプリケーションを中心に、設定・認証・運用面の観点から脆弱性とリスクを洗い出し、改善提案をまとめたものです。コード静的確認に基づくため、実運用環境の設定やインフラ側の制御は別途確認が必要です。

## 重要度の基準
- **重大**: 直ちに悪用可能で、機密性・完全性・可用性に重大な影響。
- **中**: 悪用には条件が必要だが、影響は大きい。
- **低**: 直接の被害は小さいが、脆弱性の足掛かりになり得る。

## 検出結果（要約）
- **重大**: 2件
- **中**: 4件
- **低**: 2件

---

## 重大

### 1. 既定の `SECRET_KEY` が弱い値にフォールバック
**概要**: `SECRET_KEY` 未設定時に固定の弱いキーが使用されます。セッション改ざんやCookie署名の偽造につながる可能性があります。

**根拠**: `app.secret_key` が環境変数未設定時に固定文字列へフォールバック。

**影響**: セッション乗っ取り、認証回避、CSRFトークン偽造の可能性。

**推奨対策**:
- 本番環境では必ずランダムで十分長い `SECRET_KEY` を環境変数で設定。
- 起動時に `SECRET_KEY` 未設定なら起動を止める（フェイルクローズ）。

---

### 2. デバッグモードでの起動
**概要**: `debug=True` で起動されます。Flaskデバッグモードはリモートコード実行に繋がる危険が高く、本番では禁止すべきです。

**根拠**: `app.run(debug=True, host="0.0.0.0", ...)` が指定されている。

**影響**: デバッガPIN突破で任意コード実行の危険。

**推奨対策**:
- 本番環境では `debug=False` を強制。
- 環境変数で切り替える場合も本番では固定で無効化。

---

## 中

### 3. 認証系フォームにCSRF対策が見当たらない
**概要**: ログイン／登録フォームにCSRFトークンが利用されていないため、CSRF攻撃が成立する可能性があります。

**根拠**: `routes/auth.py` にCSRF対策の実装がなく、テンプレートにもトークンの埋め込みがない。

**影響**: 悪意のあるサイト経由で意図しない操作（登録・ログインなど）を実行される危険。

**推奨対策**:
- `Flask-WTF` などでCSRF保護を有効化し、フォームにトークンを埋め込む。

---

### 4. パスワードポリシー不在
**概要**: 登録時のパスワード強度チェックが無く、推測容易なパスワードが設定可能です。

**根拠**: 登録時に強度チェックの実装がない。

**影響**: ブルートフォース・クレデンシャルスタッフィングへの耐性が低下。

**推奨対策**:
- 最低長、英数記号の混在等のポリシーを導入。
- `haveibeenpwned` 等の漏洩パスワードチェックも検討。

---

### 5. ログイン／登録のレート制限が無い
**概要**: 認証エンドポイントに対するレート制限が無いので、パスワード総当たりやアカウント列挙が可能になります。

**根拠**: レート制御の実装が見当たらない。

**影響**: ブルートフォースやアカウント列挙のリスク。

**推奨対策**:
- `Flask-Limiter` などでIPベースの制限を導入。
- 失敗回数に応じた一時ロックやCAPTCHA導入。

---

### 6. 例外メッセージがユーザへ露出
**概要**: 登録処理で例外メッセージをそのまま画面に返しており、内部情報が漏えいする可能性があります。

**根拠**: `register()` の例外処理で `error=f"Error: {e}"` を返す。

**影響**: DB構造などの内部情報が推測されるリスク。

**推奨対策**:
- エラーメッセージはユーザ向けに一般化し、詳細はログに記録。

---

## 低

### 7. DB接続情報のデバッグ出力
**概要**: 起動時にDB URLを標準出力に表示します。環境変数に資格情報を含む場合、漏えいリスクがあります。

**根拠**: `print(f"DEBUG: Using database URL: {database_url}")` が存在。

**影響**: ログから資格情報が漏れる可能性。

**推奨対策**:
- 本番では接続情報をログ出力しない。
- 必要ならマスクして出力。

---

### 8. テスト用スクリプトに固定パスワード
**概要**: テスト/検証スクリプトに固定パスワードが記載されており、運用で誤使用されるリスクがあります。

**根拠**: `create_test_user.py` や `verify_*` で固定文字列を使用。

**影響**: 本番環境で誤って実行された場合の危険。

**推奨対策**:
- テスト専用であることを明示し、実行環境を分離。
- 可能であれば環境変数化。

---

## 追加の確認推奨事項
- **HTTPS強制**: `ProxyFix` を使用しているため、ロードバランサー／リバースプロキシ側でHTTPS強制が適切か確認。
- **セッション保護**: `SESSION_COOKIE_SECURE`/`SESSION_COOKIE_HTTPONLY`/`SESSION_COOKIE_SAMESITE` の設定。
- **依存関係の脆弱性**: `requirements.txt` の依存関係に対して `pip-audit` などで脆弱性スキャン。

---

## まとめ
現状は「開発環境のまま本番運用されると危険な設定」が目立ちます。特に `SECRET_KEY` の固定値と `debug=True` は即時改善が必要です。加えて、CSRF対策・レート制限・パスワードポリシーの導入は、認証機能の安全性を大きく向上させます。
