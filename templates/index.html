{% extends "base.html" %}

{% block title %}å•†å“ä¸€è¦§ï¼ˆmercari.dbï¼‰{% endblock %}
{% block header_title %}å•†å“ä¸€è¦§{% endblock %}

{% block content %}
<div class="page-header">
    <h1>å•†å“ä¸€è¦§</h1>
    <p class="page-subtitle">{{ selected_site or "å…¨ã‚µã‚¤ãƒˆ" }} / {{ selected_status or "å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹" }}</p>
</div>

<!-- ã‚µã‚¤ãƒˆåˆ¥çµ±è¨ˆãƒãƒƒã‚¸ -->
<div class="site-stats-bar">
    <a href="{{ url_for('index') }}" class="site-badge {{ 'active' if not selected_site else '' }}">
        å…¨ã¦ <span class="site-badge-count">{{ total_count }}</span>
    </a>
    {% for site_name, count in site_stats.items() %}
    <a href="{{ url_for('index', site=site_name) }}"
        class="site-badge {{ 'active' if selected_site == site_name else '' }}">
        {{ site_name }} <span class="site-badge-count">{{ count }}</span>
    </a>
    {% endfor %}
</div>

<!-- ãƒ•ã‚£ãƒ«ã‚¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒ¢ãƒã‚¤ãƒ«ã§ã¯æŠ˜ã‚ŠãŸãŸã¿ï¼‰ -->
<details class="mobile-collapsible mobile-only" id="filterSection">
    <summary class="mobile-collapsible-header">
        <span class="mobile-collapsible-title">ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ»æ¤œç´¢</span>
        <span class="mobile-collapsible-icon">â–¶</span>
    </summary>
    <div class="mobile-collapsible-content">
        <form method="GET" action="{{ url_for('index') }}">
            <div class="filter-grid">
                <!-- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ -->
                <div class="filter-group filter-group--full">
                    <label>ğŸ” ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢</label>
                    <input type="text" name="search" value="{{ search_keyword }}" placeholder="å•†å“åã§æ¤œç´¢...">
                </div>
                <div class="filter-group">
                    <label>ã‚µã‚¤ãƒˆ</label>
                    <select name="site">
                        <option value="">(ã™ã¹ã¦)</option>
                        {% for s in sites %}
                        <option value="{{ s }}" {% if s==selected_site %}selected{% endif %}>{{ s }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                    <select name="status">
                        <option value="">(ã™ã¹ã¦)</option>
                        {% for st in statuses %}
                        <option value="{{ st }}" {% if st==selected_status %}selected{% endif %}>{{ st }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label>å¤‰æ›´</label>
                    <select name="change_filter">
                        <option value="">(ã™ã¹ã¦)</option>
                        <option value="changed" {% if selected_change_filter=='changed' %}selected{% endif %}>å¤‰æ›´ã‚ã‚Šã®ã¿
                        </option>
                    </select>
                </div>
                <!-- ä¾¡æ ¼å¸¯ãƒ•ã‚£ãƒ«ã‚¿ -->
                <div class="filter-group">
                    <label>ğŸ’° æœ€ä½ä¾¡æ ¼</label>
                    <input type="number" name="price_min" value="{{ price_min }}" placeholder="Â¥0" inputmode="numeric">
                </div>
                <div class="filter-group">
                    <label>ğŸ’° æœ€é«˜ä¾¡æ ¼</label>
                    <input type="number" name="price_max" value="{{ price_max }}" placeholder="Â¥999,999"
                        inputmode="numeric">
                </div>
                <!-- ã‚½ãƒ¼ãƒˆ -->
                <div class="filter-group">
                    <label>ğŸ“Š ä¸¦ã³é †</label>
                    <select name="sort">
                        <option value="updated_desc" {% if sort_by=='updated_desc' %}selected{% endif %}>æ›´æ–°æ—¥ï¼ˆæ–°ã—ã„é †ï¼‰
                        </option>
                        <option value="created_desc" {% if sort_by=='created_desc' %}selected{% endif %}>ç™»éŒ²æ—¥ï¼ˆæ–°ã—ã„é †ï¼‰
                        </option>
                        <option value="created_asc" {% if sort_by=='created_asc' %}selected{% endif %}>ç™»éŒ²æ—¥ï¼ˆå¤ã„é †ï¼‰</option>
                        <option value="price_desc" {% if sort_by=='price_desc' %}selected{% endif %}>ä¾¡æ ¼ï¼ˆé«˜ã„é †ï¼‰</option>
                        <option value="price_asc" {% if sort_by=='price_asc' %}selected{% endif %}>ä¾¡æ ¼ï¼ˆå®‰ã„é †ï¼‰</option>
                    </select>
                </div>
            </div>
            <div class="filter-actions">
                <button type="submit">ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨</button>
                <a href="{{ url_for('index') }}" class="btn btn-secondary">ã‚¯ãƒªã‚¢</a>
            </div>
        </form>
    </div>
</details>


<!-- PCç”¨ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰ -->
<div class="filter-section desktop-only">
    <form method="GET" action="{{ url_for('index') }}">
        <div class="filter-section-body">
            <div class="filter-grid filter-grid--desktop">
                <!-- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ -->
                <div class="filter-group filter-group--span-2">
                    <label>ğŸ” ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢</label>
                    <input type="text" name="search" value="{{ search_keyword }}" placeholder="å•†å“åã§æ¤œç´¢...">
                </div>
                <div class="filter-group">
                    <label>ã‚µã‚¤ãƒˆ</label>
                    <select name="site">
                        <option value="">(ã™ã¹ã¦)</option>
                        {% for s in sites %}
                        <option value="{{ s }}" {% if s==selected_site %}selected{% endif %}>{{ s }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                    <select name="status">
                        <option value="">(ã™ã¹ã¦)</option>
                        {% for st in statuses %}
                        <option value="{{ st }}" {% if st==selected_status %}selected{% endif %}>{{ st }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label>å¤‰æ›´</label>
                    <select name="change_filter">
                        <option value="">(ã™ã¹ã¦)</option>
                        <option value="changed" {% if selected_change_filter=='changed' %}selected{% endif %}>å¤‰æ›´ã‚ã‚Šã®ã¿
                        </option>
                    </select>
                </div>
                <!-- ä¾¡æ ¼å¸¯ãƒ•ã‚£ãƒ«ã‚¿ -->
                <div class="filter-group">
                    <label>ğŸ’° æœ€ä½ä¾¡æ ¼</label>
                    <input type="number" name="price_min" value="{{ price_min }}" placeholder="Â¥0" inputmode="numeric">
                </div>
                <div class="filter-group">
                    <label>ğŸ’° æœ€é«˜ä¾¡æ ¼</label>
                    <input type="number" name="price_max" value="{{ price_max }}" placeholder="Â¥999,999"
                        inputmode="numeric">
                </div>
                <!-- ã‚½ãƒ¼ãƒˆ -->
                <div class="filter-group">
                    <label>ğŸ“Š ä¸¦ã³é †</label>
                    <select name="sort">
                        <option value="updated_desc" {% if sort_by=='updated_desc' %}selected{% endif %}>æ›´æ–°æ—¥ï¼ˆæ–°ã—ã„é †ï¼‰
                        </option>
                        <option value="created_desc" {% if sort_by=='created_desc' %}selected{% endif %}>ç™»éŒ²æ—¥ï¼ˆæ–°ã—ã„é †ï¼‰
                        </option>
                        <option value="created_asc" {% if sort_by=='created_asc' %}selected{% endif %}>ç™»éŒ²æ—¥ï¼ˆå¤ã„é †ï¼‰</option>
                        <option value="price_desc" {% if sort_by=='price_desc' %}selected{% endif %}>ä¾¡æ ¼ï¼ˆé«˜ã„é †ï¼‰</option>
                        <option value="price_asc" {% if sort_by=='price_asc' %}selected{% endif %}>ä¾¡æ ¼ï¼ˆå®‰ã„é †ï¼‰</option>
                    </select>
                </div>
            </div>
            <div class="filter-actions">
                <button type="submit">ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨</button>
                <a href="{{ url_for('index') }}" class="btn btn-secondary">ã‚¯ãƒªã‚¢</a>
            </div>
        </div>
    </form>
</div>


<!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”¨ãƒ•ã‚©ãƒ¼ãƒ  -->
<form method="GET">
    <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆè¨­å®šï¼ˆãƒ¢ãƒã‚¤ãƒ«ã§ã¯æŠ˜ã‚ŠãŸãŸã¿ï¼‰ -->
    <details class="mobile-collapsible mobile-only">
        <summary class="mobile-collapsible-header">
            <span class="mobile-collapsible-title">âš™ï¸ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆè¨­å®š</span>
            <span class="mobile-collapsible-icon">â–¶</span>
        </summary>
        <div class="mobile-collapsible-content">
            <div class="export-grid">
                <div class="filter-group">
                    <label>ä¾¡æ ¼å€ç‡</label>
                    <input type="number" id="markup_mobile" name="markup" value="{{ default_markup }}" step="0.01"
                        oninput="updateProfitMarginMobile()" inputmode="decimal">
                    <span class="text-small text-muted">1.0=ãã®ã¾ã¾ / 1.2=20%ä¸Šä¹—ã›</span>
                </div>
                <div class="filter-group">
                    <label>åˆ©ç›Šç‡ (%)</label>
                    <input type="number" id="profit_margin_mobile" step="1" oninput="updateMarkupMobile()"
                        inputmode="numeric">
                </div>
                <div class="filter-group">
                    <label>åœ¨åº«æ•°</label>
                    <input type="number" name="qty" value="{{ default_qty }}" step="1" min="0" inputmode="numeric">
                </div>
                <div class="filter-group">
                    <label>ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ</label>
                    <input type="number" name="rate" value="{{ default_rate }}" step="0.01" inputmode="decimal">
                </div>
            </div>

            <!-- eBayè¨­å®š -->
            <details class="collapsible-section mt-2">
                <summary>eBay è©³ç´°è¨­å®š</summary>
                <div class="actions">
                    <div class="filter-group">
                        <label>ã‚«ãƒ†ã‚´ãƒªID</label>
                        <input type="text" name="ebay_category_id" value="{{ default_ebay_category_id }}"
                            placeholder="ä¾‹: 183454">
                    </div>
                    <div class="filter-group">
                        <label>ConditionID</label>
                        <input type="text" name="ebay_condition_id" value="{{ default_ebay_condition_id }}"
                            placeholder="æ–°å“=1000">
                    </div>
                    <div class="filter-group">
                        <label>PaymentProfile</label>
                        <input type="text" name="ebay_payment_profile" value="{{ default_ebay_payment_profile }}">
                    </div>
                    <div class="filter-group">
                        <label>ReturnProfile</label>
                        <input type="text" name="ebay_return_profile" value="{{ default_ebay_return_profile }}">
                    </div>
                    <div class="filter-group">
                        <label>ShippingProfile</label>
                        <input type="text" name="ebay_shipping_profile" value="{{ default_ebay_shipping_profile }}">
                    </div>
                    <div class="filter-group">
                        <label>PayPalEmail</label>
                        <input type="text" name="ebay_paypal_email" value="{{ default_ebay_paypal_email }}">
                    </div>
                </div>
            </details>

            <div class="export-btn-grid mt-2">
                <button type="submit" formaction="{{ url_for('export_shopify') }}">Shopify CSV</button>
                <button type="submit" formaction="{{ url_for('export_ebay') }}">eBay CSV</button>
                <button type="submit" formaction="{{ url_for('export_stock_update') }}">åœ¨åº«æ›´æ–°CSV</button>
                <button type="submit" formaction="{{ url_for('export_price_update') }}">ä¾¡æ ¼æ›´æ–°CSV</button>
            </div>
        </div>
    </details>

    <!-- PCç”¨ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆè¨­å®š -->
    <div class="export-section desktop-only">
        <div class="export-section-body">
            <div class="export-grid">
                <div class="filter-group">
                    <label>ä¾¡æ ¼å€ç‡ (markup)</label>
                    <input type="number" id="markup" name="markup" value="{{ default_markup }}" step="0.01"
                        oninput="updateProfitMargin()" inputmode="decimal">
                    <span class="text-small text-muted">1.0=ãã®ã¾ã¾ / 1.2=20%ä¸Šä¹—ã›</span>
                </div>
                <div class="filter-group">
                    <label>åˆ©ç›Šç‡ (%)</label>
                    <input type="number" id="profit_margin" step="1" oninput="updateMarkup()" inputmode="numeric">
                    <span class="text-small text-muted">ä¾¡æ ¼å€ç‡ã¨é€£å‹•ã—ã¾ã™</span>
                </div>
                <div class="filter-group">
                    <label>åœ¨åº«æ•° (Quantity)</label>
                    <input type="number" name="qty" value="{{ default_qty }}" step="1" min="0" inputmode="numeric">
                </div>
                <div class="filter-group">
                    <label>ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ (JPY â†’ USD)</label>
                    <input type="number" name="rate" value="{{ default_rate }}" step="0.01" inputmode="decimal">
                    <span class="text-small text-muted">1ãƒ‰ãƒ«ã‚ãŸã‚Šã®å††</span>
                </div>
            </div>

            <!-- eBayè¨­å®šï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰ -->
            <details class="collapsible-section mt-2">
                <summary>eBay è©³ç´°è¨­å®š</summary>
                <div class="actions">
                    <div class="filter-group">
                        <label>eBay ã‚«ãƒ†ã‚´ãƒªID (Category)</label>
                        <input type="text" name="ebay_category_id" value="{{ default_ebay_category_id }}"
                            placeholder="ä¾‹: 183454">
                    </div>
                    <div class="filter-group">
                        <label>eBay ConditionID</label>
                        <input type="text" name="ebay_condition_id" value="{{ default_ebay_condition_id }}"
                            placeholder="æ–°å“=1000 / ä¸­å¤=3000">
                    </div>
                    <div class="filter-group">
                        <label>PaymentProfileName</label>
                        <input type="text" name="ebay_payment_profile" value="{{ default_ebay_payment_profile }}"
                            placeholder="ä¾‹: payAddress">
                    </div>
                    <div class="filter-group">
                        <label>ReturnProfileName</label>
                        <input type="text" name="ebay_return_profile" value="{{ default_ebay_return_profile }}"
                            placeholder="ä¾‹: return Buyer pays for shipping">
                    </div>
                    <div class="filter-group">
                        <label>ShippingProfileName</label>
                        <input type="text" name="ebay_shipping_profile" value="{{ default_ebay_shipping_profile }}"
                            placeholder="ä¾‹: [US DDP] $132.01â€“$198">
                    </div>
                    <div class="filter-group">
                        <label>PayPalEmailAddress</label>
                        <input type="text" name="ebay_paypal_email" value="{{ default_ebay_paypal_email }}"
                            placeholder="ä¾‹: your-paypal@example.com">
                    </div>
                </div>
            </details>

            <div class="export-btn-grid mt-2">
                <button type="submit" formaction="{{ url_for('export_shopify') }}">Shopify é¢¨ CSV</button>
                <button type="submit" formaction="{{ url_for('export_ebay') }}">eBay File Exchange ç”¨ CSV</button>
                <button type="submit" formaction="{{ url_for('export_stock_update') }}">Shopify åœ¨åº«æ›´æ–°CSV</button>
                <button type="submit" formaction="{{ url_for('export_price_update') }}">Shopify ä¾¡æ ¼æ›´æ–°CSV</button>
                <button type="submit" formaction="{{ url_for('export.export_images') }}">ğŸ“· ç”»åƒZIP</button>
            </div>
        </div>
    </div>


    <!-- Batch Edit Action Bar -->
    <div class="batch-action-bar">
        <div class="batch-action-group">
            <input type="checkbox" id="selectAll">
            <label for="selectAll" class="batch-action-label">ã™ã¹ã¦é¸æŠ</label>
            <span id="selectedCount" class="batch-action-count">(0ä»¶é¸æŠä¸­)</span>
        </div>
        <div class="batch-action-spacer"></div>
        <select id="batchAction" class="batch-action-select">
            <option value="">-- ä¸€æ‹¬æ“ä½œã‚’é¸æŠ --</option>
            <option value="prefix">ã‚¿ã‚¤ãƒˆãƒ«ã«æ¥é ­è¾ã‚’è¿½åŠ </option>
            <option value="suffix">ã‚¿ã‚¤ãƒˆãƒ«ã«æ¥å°¾è¾ã‚’è¿½åŠ </option>
            <option value="replace">æ–‡å­—åˆ—ã‚’ç½®æ›</option>
            <option value="archive">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã«ç§»å‹•</option>
            <option value="trash">ğŸ—‘ï¸ ã‚´ãƒŸç®±ã¸ç§»å‹•</option>
        </select>
        <button type="button" class="btn btn-primary" data-action="batch-edit">å®Ÿè¡Œ</button>
    </div>


    <div class="table-responsive product-table-mobile-hidden">

        <table class="product-table">
            <tr>
                <th>é¸æŠ</th>
                <th class="hide-mobile">ID</th>
                <th class="hide-mobile">ã‚µã‚¤ãƒˆ</th>
                <th>ã‚µãƒ ãƒã‚¤ãƒ«</th>
                <th>å•†å“å</th>
                <th>ä¾¡æ ¼</th>
                <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                <th class="hide-mobile">ç”»åƒæšæ•°</th>
                <th>å…ƒURL</th>
                <th>è©³ç´°</th>
                <th class="hide-mobile">æœ€çµ‚æ›´æ–°</th>
            </tr>
            {% for p in products %}
            {% set first_snapshot = p.snapshots|sort(attribute='scraped_at', reverse=true)|first if p.snapshots else
            none %}
            {% set thumb_url = first_snapshot.image_urls.split('|')[0] if first_snapshot and first_snapshot.image_urls
            else '' %}
            {% set img_count = first_snapshot.image_urls.split('|')|length if first_snapshot and
            first_snapshot.image_urls else 0 %}
            <tr class="{{ 'changed' if p.has_changed else '' }}">
                <td>
                    <input type="checkbox" name="id" value="{{ p.id }}">
                </td>
                <td class="hide-mobile">{{ p.id }}</td>
                <td class="hide-mobile">{{ p.site }}</td>
                <td>
                    {% if thumb_url %}
                    <img src="{{ thumb_url }}" alt="å•†å“ã‚µãƒ ãƒã‚¤ãƒ«" class="product-thumb">
                    {% else %}
                    <span class="product-thumb-placeholder" aria-hidden="true"></span>
                    {% endif %}
                </td>
                <td class="product-title-cell">{{ p.custom_title or p.last_title }}</td>
                <td>
                    {% if p.last_price is not none %}
                    Â¥{{ "{:,}".format(p.last_price) }}
                    {% endif %}
                </td>
                <td>{{ p.last_status }}</td>
                <td class="hide-mobile">{{ img_count }}</td>
                <td><a href="{{ p.source_url }}" target="_blank">é–‹ã</a></td>
                <td><a href="{{ url_for('product_detail', product_id=p.id) }}">ç·¨é›†</a></td>
                <td class="hide-mobile">{{ p.updated_at }}</td>
            </tr>
            {% endfor %}
        </table>
    </div>

    <!-- Mobile Product Cards (Airbnb-style) -->
    <div class="product-card-mobile">
        {% for p in products %}
        {% set first_snapshot = p.snapshots|sort(attribute='scraped_at', reverse=true)|first if p.snapshots else none %}
        {% set thumb_url = first_snapshot.image_urls.split('|')[0] if first_snapshot and first_snapshot.image_urls else
        '' %}
        <div class="product-card {{ 'changed' if p.has_changed else '' }}">
            <div class="product-checkbox-wrapper">
                <input type="checkbox" name="id" value="{{ p.id }}">
            </div>
            {% if thumb_url %}
            <img src="{{ thumb_url }}" alt="å•†å“ã‚µãƒ ãƒã‚¤ãƒ«" class="product-card-image">
            {% else %}
            <div class="product-card-image"></div>
            {% endif %}
            <div class="product-card-content">
                <div class="product-card-title">{{ p.custom_title or p.last_title }}</div>
                <div class="product-card-price">
                    {% if p.last_price is not none %}
                    Â¥{{ "{:,}".format(p.last_price) }}
                    {% endif %}
                </div>
                <div class="product-card-meta">
                    <span class="product-card-status {{ 'active' if p.last_status == 'å‡ºå“ä¸­' else 'draft' }}">{{
                        p.last_status }}</span>
                    <span>{{ p.site }}</span>
                </div>
            </div>
            <div class="product-card-actions">
                <a href="{{ url_for('product_detail', product_id=p.id) }}" class="btn">ç·¨é›†</a>
                <a href="{{ p.source_url }}" target="_blank" class="btn btn-muted">å…ƒ</a>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="pagination">
        {% if has_prev %}
        <a
            href="{{ url_for('index', page=page-1, site=selected_site, status=selected_status, change_filter=selected_change_filter, search=search_keyword, price_min=price_min, price_max=price_max, sort=sort_by) }}">&laquo;
            å‰</a>
        {% endif %}
        <span>{{ page }} / {{ total_pages }}</span>
        {% if has_next %}
        <a
            href="{{ url_for('index', page=page+1, site=selected_site, status=selected_status, change_filter=selected_change_filter, search=search_keyword, price_min=price_min, price_max=price_max, sort=sort_by) }}">æ¬¡
            &raquo;</a>
        {% endif %}
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
    function updateProfitMargin() {
        const markupInput = document.getElementById('markup');
        const profitMarginInput = document.getElementById('profit_margin');
        if (!markupInput || !profitMarginInput) return;
        const markup = parseFloat(markupInput.value);
        if (!isNaN(markup) && markup > 0) {
            const profitMargin = ((markup - 1) / markup) * 100;
            profitMarginInput.value = profitMargin.toFixed(0);
        } else {
            profitMarginInput.value = '';
        }
    }

    function updateMarkup() {
        const markupInput = document.getElementById('markup');
        const profitMarginInput = document.getElementById('profit_margin');
        if (!markupInput || !profitMarginInput) return;
        const profitMargin = parseFloat(profitMarginInput.value);
        if (!isNaN(profitMargin) && profitMargin < 100) {
            const markup = 1 / (1 - (profitMargin / 100));
            markupInput.value = markup.toFixed(2);
        } else {
            markupInput.value = '';
        }
    }

    function updateProfitMarginMobile() {
        const markupInput = document.getElementById('markup_mobile');
        const profitMarginInput = document.getElementById('profit_margin_mobile');
        if (!markupInput || !profitMarginInput) return;
        const markup = parseFloat(markupInput.value);
        if (!isNaN(markup) && markup > 0) {
            const profitMargin = ((markup - 1) / markup) * 100;
            profitMarginInput.value = profitMargin.toFixed(0);
        } else {
            profitMarginInput.value = '';
        }
    }

    function updateMarkupMobile() {
        const markupInput = document.getElementById('markup_mobile');
        const profitMarginInput = document.getElementById('profit_margin_mobile');
        if (!markupInput || !profitMarginInput) return;
        const profitMargin = parseFloat(profitMarginInput.value);
        if (!isNaN(profitMargin) && profitMargin < 100) {
            const markup = 1 / (1 - (profitMargin / 100));
            markupInput.value = markup.toFixed(2);
        } else {
            markupInput.value = '';
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        updateProfitMargin();
        updateProfitMarginMobile();
        updateSelectedCount();

        // Add change listener to all checkboxes
        document.querySelectorAll('input[name="id"]').forEach(cb => {
            cb.addEventListener('change', updateSelectedCount);
        });

        const selectAll = document.getElementById('selectAll');
        if (selectAll) {
            selectAll.addEventListener('change', function () {
                toggleSelectAll(selectAll);
            });
        }

        const batchEditButton = document.querySelector('[data-action="batch-edit"]');
        if (batchEditButton) {
            batchEditButton.addEventListener('click', showBatchEditModal);
        }
    });

    // Batch edit functions
    function toggleSelectAll(source) {
        const checkboxes = document.querySelectorAll('input[name="id"]');
        checkboxes.forEach(cb => cb.checked = source.checked);
        updateSelectedCount();
    }

    function updateSelectedCount() {
        const checked = document.querySelectorAll('input[name="id"]:checked').length;
        document.getElementById('selectedCount').textContent = `(${checked}ä»¶é¸æŠä¸­)`;
    }

    function getSelectedIds() {
        return Array.from(document.querySelectorAll('input[name="id"]:checked')).map(cb => cb.value);
    }

    function showBatchEditModal() {
        const action = document.getElementById('batchAction').value;
        const selectedIds = getSelectedIds();

        if (!action) {
            alert('æ“ä½œã‚’é¸æŠã—ã¦ãã ã•ã„');
            return;
        }
        if (selectedIds.length === 0) {
            alert('å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„');
            return;
        }

        let input = '';
        let input2 = '';

        if (action === 'prefix') {
            input = prompt('è¿½åŠ ã™ã‚‹æ¥é ­è¾ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', 'ã€æ–°ç€ã€‘');
        } else if (action === 'suffix') {
            input = prompt('è¿½åŠ ã™ã‚‹æ¥å°¾è¾ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', ' - é€æ–™ç„¡æ–™');
        } else if (action === 'replace') {
            input = prompt('ç½®æ›å¯¾è±¡ã®æ–‡å­—åˆ—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (input) {
                input2 = prompt('ç½®æ›å¾Œã®æ–‡å­—åˆ—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            }
        } else if (action === 'archive') {
            if (confirm(`${selectedIds.length}ä»¶ã®å•†å“ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã«ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ`)) {
                // Submit to archive route
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '{{ url_for("archive.archive_products") }}';
                selectedIds.forEach(id => {
                    const field = document.createElement('input');
                    field.type = 'hidden';
                    field.name = 'ids';
                    field.value = id;
                    form.appendChild(field);
                });
                document.body.appendChild(form);
                form.submit();
                return;
            }
            return;
        } else if (action === 'trash') {
            if (confirm(`${selectedIds.length}ä»¶ã®å•†å“ã‚’ã‚´ãƒŸç®±ã«ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ`)) {
                // Submit to trash route
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '{{ url_for("trash.trash_delete") }}';
                selectedIds.forEach(id => {
                    const field = document.createElement('input');
                    field.type = 'hidden';
                    field.name = 'id';
                    field.value = id;
                    form.appendChild(field);
                });
                document.body.appendChild(form);
                form.submit();
                return;
            }
            return;
        }

        if (!input && input !== '') return;

        // Submit batch edit
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("main.batch_edit") }}';


        const addHidden = (name, value) => {
            const field = document.createElement('input');
            field.type = 'hidden';
            field.name = name;
            field.value = value;
            form.appendChild(field);
        };

        addHidden('action', action);
        addHidden('input', input);
        addHidden('input2', input2 || '');
        selectedIds.forEach(id => addHidden('ids', id));

        document.body.appendChild(form);
        form.submit();
    }
</script>
{% endblock %}
