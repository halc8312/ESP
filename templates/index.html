<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<title>商品一覧（mercari.db）</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

<body>
    <div class="nav">
        <div>
            <a href="{{ url_for('index') }}">商品一覧</a>
            <a href="{{ url_for('scrape_form') }}">新規スクレイピング</a>
            <a href="{{ url_for('manage_templates') }}">テンプレート</a>
            <a href="{{ url_for('manage_shops') }}">ショップ管理</a>
        </div>
        <div>
            <form action="{{ url_for('set_current_shop') }}" method="post" style="margin:0;">
                <select name="shop_id" onchange="this.form.submit()">
                    <option value="">(ショップ未選択)</option>
                    {% for s in all_shops %}
                    <option value="{{ s.id }}" {% if current_shop_id==s.id %}selected{% endif %}>
                        {{ s.name }}
                    </option>
                    {% endfor %}
                </select>
            </form>
        </div>
    </div>

    <h1>商品一覧（{{ selected_site or "全サイト" }} / {{ selected_status or "全ステータス" }}）</h1>

    <!-- フィルタフォーム -->
    <form method="GET" action="{{ url_for('index') }}">
        <div class="filters">
            <label>
                サイト:
                <select name="site">
                    <option value="">(すべて)</option>
                    {% for s in sites %}
                    <option value="{{ s }}" {% if s==selected_site %}selected{% endif %}>{{ s }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>
                ステータス:
                <select name="status">
                    <option value="">(すべて)</option>
                    {% for st in statuses %}
                    <option value="{{ st }}" {% if st==selected_status %}selected{% endif %}>{{ st }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>
                変更:
                <select name="change_filter">
                    <option value="">(すべて)</option>
                    <option value="changed" {% if selected_change_filter=='changed' %}selected{% endif %}>変更ありのみ
                    </option>
                </select>
            </label>
            <button type="submit">フィルタ</button>
        </div>
    </form>

    <!-- エクスポート用フォーム -->
    <form method="GET">
        <div class="actions">
            <!-- 基本設定（常に表示） -->
            <div>
                <label>価格倍率 (markup)</label>
                <input type="number" id="markup" name="markup" value="{{ default_markup }}" step="0.01"
                    oninput="updateProfitMargin()" inputmode="decimal">
                <span style="font-size: 11px; color: #555;">1.0=そのまま / 1.2=20%上乗せ</span>
            </div>
            <div>
                <label>利益率 (%)</label>
                <input type="number" id="profit_margin" step="1" oninput="updateMarkup()" inputmode="numeric">
                <span style="font-size: 11px; color: #555;">価格倍率と連動します</span>
            </div>
            <div>
                <label>在庫数 (Quantity)</label>
                <input type="number" name="qty" value="{{ default_qty }}" step="1" min="0" inputmode="numeric">
            </div>
            <div>
                <label>為替レート (JPY → USD)</label>
                <input type="number" name="rate" value="{{ default_rate }}" step="0.01" inputmode="decimal">
                <span style="font-size: 11px; color: #555;">1ドルあたりの円（例: 155）</span>
            </div>
        </div>

        <!-- eBay設定（折りたたみ） -->
        <details class="collapsible-section">
            <summary>eBay 詳細設定</summary>
            <div class="actions" style="margin-top: 10px;">
                <div>
                    <label>eBay カテゴリID (Category)</label>
                    <input type="text" name="ebay_category_id" value="{{ default_ebay_category_id }}"
                        placeholder="例: 183454">
                </div>
                <div>
                    <label>eBay ConditionID</label>
                    <input type="text" name="ebay_condition_id" value="{{ default_ebay_condition_id }}"
                        placeholder="新品=1000 / 中古=3000">
                </div>
                <div>
                    <label>PaymentProfileName</label>
                    <input type="text" name="ebay_payment_profile" value="{{ default_ebay_payment_profile }}"
                        placeholder="例: payAddress">
                </div>
                <div>
                    <label>ReturnProfileName</label>
                    <input type="text" name="ebay_return_profile" value="{{ default_ebay_return_profile }}"
                        placeholder="例: return Buyer pays for shipping">
                </div>
                <div>
                    <label>ShippingProfileName</label>
                    <input type="text" name="ebay_shipping_profile" value="{{ default_ebay_shipping_profile }}"
                        placeholder="例: [US DDP] $132.01–$198">
                </div>
                <div>
                    <label>PayPalEmailAddress</label>
                    <input type="text" name="ebay_paypal_email" value="{{ default_ebay_paypal_email }}"
                        placeholder="例: your-paypal@example.com">
                </div>
            </div>
        </details>

        <div class="export-buttons" style="margin: 15px 0;">
            <button type="submit" formaction="{{ url_for('export_shopify') }}">
                Shopify 風 CSV
            </button>
            <button type="submit" formaction="{{ url_for('export_ebay') }}">
                eBay File Exchange 用 CSV
            </button>
            <button type="submit" formaction="{{ url_for('export_stock_update') }}">
                Shopify 在庫更新CSV
            </button>
            <button type="submit" formaction="{{ url_for('export_price_update') }}">
                Shopify 価格更新CSV
            </button>
        </div>

        <div class="table-responsive">
            <table class="product-table">
                <tr>
                    <th>選択</th>
                    <th class="hide-mobile">ID</th>
                    <th class="hide-mobile">サイト</th>
                    <th>サムネイル</th>
                    <th>商品名</th>
                    <th>価格</th>
                    <th>ステータス</th>
                    <th class="hide-mobile">画像枚数</th>
                    <th>元URL</th>
                    <th>詳細</th>
                    <th class="hide-mobile">最終更新</th>
                </tr>
                {% for p in products %}
                <tr class="{{ 'changed' if p.has_changed else '' }}">
                    <td>
                        <input type="checkbox" name="id" value="{{ p.id }}">
                    </td>
                    <td class="hide-mobile">{{ p.id }}</td>
                    <td class="hide-mobile">{{ p.site }}</td>
                    <td>
                        {% if thumb_url %}
                        <img src="{{ thumb_url }}" alt="thumb" style="max-height: 80px;">
                        {% endif %}
                    </td>
                    <td class="product-title-cell">{{ p.last_title }}</td>
                    <td>
                        {% if p.last_price is not none %}
                        ¥{{ "{:,}".format(p.last_price) }}
                        {% endif %}
                    </td>
                    <td>{{ p.last_status }}</td>
                    <td class="hide-mobile">{{ image_count }}</td>
                    <td><a href="{{ p.source_url }}" target="_blank">開く</a></td>
                    <td><a href="{{ url_for('product_detail', product_id=p.id) }}">編集</a></td>
                    <td class="hide-mobile">{{ p.updated_at }}</td>
                </tr>
                {% endfor %}
            </table>
        </div>

        <div class="pagination">
            {% if has_prev %}
            <a href="{{ url_for('index', page=page-1, site=selected_site, status=selected_status) }}">&laquo; 前のページ</a>
            {% endif %}
            <span>ページ {{ page }} / {{ total_pages }}</span>
            {% if has_next %}
            <a href="{{ url_for('index', page=page+1, site=selected_site, status=selected_status) }}">次のページ &raquo;</a>
            {% endif %}
        </div>
    </form>
    <script>
        function updateProfitMargin() {
            const markupInput = document.getElementById('markup');
            const profitMarginInput = document.getElementById('profit_margin');
            const markup = parseFloat(markupInput.value);
            if (!isNaN(markup) && markup > 0) {
                // 利益率 = (売上 - 仕入) / 売上
                // markup = 売上 / 仕入
                // 利益率 = (markup - 1) / markup * 100
                const profitMargin = ((markup - 1) / markup) * 100;
                profitMarginInput.value = profitMargin.toFixed(0);
            } else {
                profitMarginInput.value = '';
            }
        }

        function updateMarkup() {
            const markupInput = document.getElementById('markup');
            const profitMarginInput = document.getElementById('profit_margin');
            const profitMargin = parseFloat(profitMarginInput.value);
            if (!isNaN(profitMargin) && profitMargin < 100) {
                // markup = 1 / (1 - (利益率 / 100))
                const markup = 1 / (1 - (profitMargin / 100));
                markupInput.value = markup.toFixed(2);
            } else {
                markupInput.value = '';
            }
        }

        // ページ読み込み時に初期値を設定
        document.addEventListener('DOMContentLoaded', function () {
            // markupの値から利益率を計算して表示
            updateProfitMargin();
        });
    </script>
</body>

</html>