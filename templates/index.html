{% extends "base.html" %}

{% block title %}ÂïÜÂìÅ‰∏ÄË¶ßÔºàmercari.dbÔºâ{% endblock %}
{% block header_title %}ÂïÜÂìÅ‰∏ÄË¶ß{% endblock %}

{% block content %}
    <div class="page-header">
        <h1>ÂïÜÂìÅ‰∏ÄË¶ß</h1>
        <p class="page-subtitle">{{ selected_site or "ÂÖ®„Çµ„Ç§„Éà" }} / {{ selected_status or "ÂÖ®„Çπ„ÉÜ„Éº„Çø„Çπ" }}</p>
    </div>

    <!-- „Éï„Ç£„É´„Çø„Çª„ÇØ„Ç∑„Éß„É≥Ôºà„É¢„Éê„Ç§„É´„Åß„ÅØÊäò„Çä„Åü„Åü„ÅøÔºâ -->
    <details class="mobile-collapsible mobile-only" id="filterSection">
        <summary class="mobile-collapsible-header">
            <span class="mobile-collapsible-title">üîç „Éï„Ç£„É´„Çø</span>
            <span class="mobile-collapsible-icon">‚ñ∂</span>
        </summary>
        <div class="mobile-collapsible-content">
            <form method="GET" action="{{ url_for('index') }}">
                <div class="filter-grid">
                    <div class="filter-group">
                        <label>„Çµ„Ç§„Éà</label>
                        <select name="site">
                            <option value="">(„Åô„Åπ„Å¶)</option>
                            {% for s in sites %}
                            <option value="{{ s }}" {% if s==selected_site %}selected{% endif %}>{{ s }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>„Çπ„ÉÜ„Éº„Çø„Çπ</label>
                        <select name="status">
                            <option value="">(„Åô„Åπ„Å¶)</option>
                            {% for st in statuses %}
                            <option value="{{ st }}" {% if st==selected_status %}selected{% endif %}>{{ st }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Â§âÊõ¥</label>
                        <select name="change_filter">
                            <option value="">(„Åô„Åπ„Å¶)</option>
                            <option value="changed" {% if selected_change_filter=='changed' %}selected{% endif %}>Â§âÊõ¥„ÅÇ„Çä„ÅÆ„Åø</option>
                        </select>
                    </div>
                </div>
                <div class="filter-actions">
                    <button type="submit">„Éï„Ç£„É´„Çø„ÇíÈÅ©Áî®</button>
                </div>
            </form>
        </div>
    </details>

    <!-- PCÁî®„Éï„Ç£„É´„ÇøÔºàÂ∏∏„Å´Ë°®Á§∫Ôºâ -->
    <div class="filter-section desktop-only">
        <form method="GET" action="{{ url_for('index') }}">
            <div class="filter-section-body">
                <div class="filter-grid">
                    <div class="filter-group">
                        <label>„Çµ„Ç§„Éà</label>
                        <select name="site">
                            <option value="">(„Åô„Åπ„Å¶)</option>
                            {% for s in sites %}
                            <option value="{{ s }}" {% if s==selected_site %}selected{% endif %}>{{ s }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>„Çπ„ÉÜ„Éº„Çø„Çπ</label>
                        <select name="status">
                            <option value="">(„Åô„Åπ„Å¶)</option>
                            {% for st in statuses %}
                            <option value="{{ st }}" {% if st==selected_status %}selected{% endif %}>{{ st }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Â§âÊõ¥</label>
                        <select name="change_filter">
                            <option value="">(„Åô„Åπ„Å¶)</option>
                            <option value="changed" {% if selected_change_filter=='changed' %}selected{% endif %}>Â§âÊõ¥„ÅÇ„Çä„ÅÆ„Åø</option>
                        </select>
                    </div>
                </div>
                <div class="filter-actions">
                    <button type="submit">„Éï„Ç£„É´„Çø„ÇíÈÅ©Áî®</button>
                </div>
            </div>
        </form>
    </div>

    <!-- „Ç®„ÇØ„Çπ„Éù„Éº„ÉàÁî®„Éï„Ç©„Éº„É† -->
    <form method="GET">
        <!-- „Ç®„ÇØ„Çπ„Éù„Éº„ÉàË®≠ÂÆöÔºà„É¢„Éê„Ç§„É´„Åß„ÅØÊäò„Çä„Åü„Åü„ÅøÔºâ -->
        <details class="mobile-collapsible mobile-only">
            <summary class="mobile-collapsible-header">
                <span class="mobile-collapsible-title">‚öôÔ∏è „Ç®„ÇØ„Çπ„Éù„Éº„ÉàË®≠ÂÆö</span>
                <span class="mobile-collapsible-icon">‚ñ∂</span>
            </summary>
            <div class="mobile-collapsible-content">
                <div class="export-grid">
                    <div class="filter-group">
                        <label>‰æ°Ê†ºÂÄçÁéá</label>
                        <input type="number" id="markup_mobile" name="markup" value="{{ default_markup }}" step="0.01"
                            oninput="updateProfitMarginMobile()" inputmode="decimal">
                        <span class="text-small text-muted">1.0=„Åù„ÅÆ„Åæ„Åæ / 1.2=20%‰∏ä‰πó„Åõ</span>
                    </div>
                    <div class="filter-group">
                        <label>Âà©ÁõäÁéá (%)</label>
                        <input type="number" id="profit_margin_mobile" step="1" oninput="updateMarkupMobile()" inputmode="numeric">
                    </div>
                    <div class="filter-group">
                        <label>Âú®Â∫´Êï∞</label>
                        <input type="number" name="qty" value="{{ default_qty }}" step="1" min="0" inputmode="numeric">
                    </div>
                    <div class="filter-group">
                        <label>ÁÇ∫Êõø„É¨„Éº„Éà</label>
                        <input type="number" name="rate" value="{{ default_rate }}" step="0.01" inputmode="decimal">
                    </div>
                </div>

                <!-- eBayË®≠ÂÆö -->
                <details class="collapsible-section mt-2">
                    <summary>eBay Ë©≥Á¥∞Ë®≠ÂÆö</summary>
                    <div class="actions">
                        <div class="filter-group">
                            <label>„Ç´„ÉÜ„Ç¥„É™ID</label>
                            <input type="text" name="ebay_category_id" value="{{ default_ebay_category_id }}" placeholder="‰æã: 183454">
                        </div>
                        <div class="filter-group">
                            <label>ConditionID</label>
                            <input type="text" name="ebay_condition_id" value="{{ default_ebay_condition_id }}" placeholder="Êñ∞ÂìÅ=1000">
                        </div>
                        <div class="filter-group">
                            <label>PaymentProfile</label>
                            <input type="text" name="ebay_payment_profile" value="{{ default_ebay_payment_profile }}">
                        </div>
                        <div class="filter-group">
                            <label>ReturnProfile</label>
                            <input type="text" name="ebay_return_profile" value="{{ default_ebay_return_profile }}">
                        </div>
                        <div class="filter-group">
                            <label>ShippingProfile</label>
                            <input type="text" name="ebay_shipping_profile" value="{{ default_ebay_shipping_profile }}">
                        </div>
                        <div class="filter-group">
                            <label>PayPalEmail</label>
                            <input type="text" name="ebay_paypal_email" value="{{ default_ebay_paypal_email }}">
                        </div>
                    </div>
                </details>

                <div class="export-btn-grid mt-2">
                    <button type="submit" formaction="{{ url_for('export_shopify') }}">Shopify CSV</button>
                    <button type="submit" formaction="{{ url_for('export_ebay') }}">eBay CSV</button>
                    <button type="submit" formaction="{{ url_for('export_stock_update') }}">Âú®Â∫´Êõ¥Êñ∞CSV</button>
                    <button type="submit" formaction="{{ url_for('export_price_update') }}">‰æ°Ê†ºÊõ¥Êñ∞CSV</button>
                </div>
            </div>
        </details>

        <!-- PCÁî®„Ç®„ÇØ„Çπ„Éù„Éº„ÉàË®≠ÂÆö -->
        <div class="export-section desktop-only">
            <div class="export-section-body">
                <div class="export-grid">
                    <div class="filter-group">
                        <label>‰æ°Ê†ºÂÄçÁéá (markup)</label>
                        <input type="number" id="markup" name="markup" value="{{ default_markup }}" step="0.01"
                            oninput="updateProfitMargin()" inputmode="decimal">
                        <span class="text-small text-muted">1.0=„Åù„ÅÆ„Åæ„Åæ / 1.2=20%‰∏ä‰πó„Åõ</span>
                    </div>
                    <div class="filter-group">
                        <label>Âà©ÁõäÁéá (%)</label>
                        <input type="number" id="profit_margin" step="1" oninput="updateMarkup()" inputmode="numeric">
                        <span class="text-small text-muted">‰æ°Ê†ºÂÄçÁéá„Å®ÈÄ£Âãï„Åó„Åæ„Åô</span>
                    </div>
                    <div class="filter-group">
                        <label>Âú®Â∫´Êï∞ (Quantity)</label>
                        <input type="number" name="qty" value="{{ default_qty }}" step="1" min="0" inputmode="numeric">
                    </div>
                    <div class="filter-group">
                        <label>ÁÇ∫Êõø„É¨„Éº„Éà (JPY ‚Üí USD)</label>
                        <input type="number" name="rate" value="{{ default_rate }}" step="0.01" inputmode="decimal">
                        <span class="text-small text-muted">1„Éâ„É´„ÅÇ„Åü„Çä„ÅÆÂÜÜ</span>
                    </div>
                </div>

                <!-- eBayË®≠ÂÆöÔºàÊäò„Çä„Åü„Åü„ÅøÔºâ -->
                <details class="collapsible-section mt-2">
                    <summary>eBay Ë©≥Á¥∞Ë®≠ÂÆö</summary>
                    <div class="actions">
                        <div class="filter-group">
                            <label>eBay „Ç´„ÉÜ„Ç¥„É™ID (Category)</label>
                            <input type="text" name="ebay_category_id" value="{{ default_ebay_category_id }}" placeholder="‰æã: 183454">
                        </div>
                        <div class="filter-group">
                            <label>eBay ConditionID</label>
                            <input type="text" name="ebay_condition_id" value="{{ default_ebay_condition_id }}" placeholder="Êñ∞ÂìÅ=1000 / ‰∏≠Âè§=3000">
                        </div>
                        <div class="filter-group">
                            <label>PaymentProfileName</label>
                            <input type="text" name="ebay_payment_profile" value="{{ default_ebay_payment_profile }}" placeholder="‰æã: payAddress">
                        </div>
                        <div class="filter-group">
                            <label>ReturnProfileName</label>
                            <input type="text" name="ebay_return_profile" value="{{ default_ebay_return_profile }}" placeholder="‰æã: return Buyer pays for shipping">
                        </div>
                        <div class="filter-group">
                            <label>ShippingProfileName</label>
                            <input type="text" name="ebay_shipping_profile" value="{{ default_ebay_shipping_profile }}" placeholder="‰æã: [US DDP] $132.01‚Äì$198">
                        </div>
                        <div class="filter-group">
                            <label>PayPalEmailAddress</label>
                            <input type="text" name="ebay_paypal_email" value="{{ default_ebay_paypal_email }}" placeholder="‰æã: your-paypal@example.com">
                        </div>
                    </div>
                </details>

                <div class="export-btn-grid mt-2">
                    <button type="submit" formaction="{{ url_for('export_shopify') }}">Shopify È¢® CSV</button>
                    <button type="submit" formaction="{{ url_for('export_ebay') }}">eBay File Exchange Áî® CSV</button>
                    <button type="submit" formaction="{{ url_for('export_stock_update') }}">Shopify Âú®Â∫´Êõ¥Êñ∞CSV</button>
                    <button type="submit" formaction="{{ url_for('export_price_update') }}">Shopify ‰æ°Ê†ºÊõ¥Êñ∞CSV</button>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="product-table">
                <tr>
                    <th>ÈÅ∏Êäû</th>
                    <th class="hide-mobile">ID</th>
                    <th class="hide-mobile">„Çµ„Ç§„Éà</th>
                    <th>„Çµ„É†„Éç„Ç§„É´</th>
                    <th>ÂïÜÂìÅÂêç</th>
                    <th>‰æ°Ê†º</th>
                    <th>„Çπ„ÉÜ„Éº„Çø„Çπ</th>
                    <th class="hide-mobile">ÁîªÂÉèÊûöÊï∞</th>
                    <th>ÂÖÉURL</th>
                    <th>Ë©≥Á¥∞</th>
                    <th class="hide-mobile">ÊúÄÁµÇÊõ¥Êñ∞</th>
                </tr>
                {% for p in products %}
                <tr class="{{ 'changed' if p.has_changed else '' }}">
                    <td>
                        <input type="checkbox" name="id" value="{{ p.id }}">
                    </td>
                    <td class="hide-mobile">{{ p.id }}</td>
                    <td class="hide-mobile">{{ p.site }}</td>
                    <td>
                        {% if thumb_url %}
                        <img src="{{ thumb_url }}" alt="thumb" style="max-height: 80px;">
                        {% endif %}
                    </td>
                    <td class="product-title-cell">{{ p.last_title }}</td>
                    <td>
                        {% if p.last_price is not none %}
                        ¬•{{ "{:,}".format(p.last_price) }}
                        {% endif %}
                    </td>
                    <td>{{ p.last_status }}</td>
                    <td class="hide-mobile">{{ image_count }}</td>
                    <td><a href="{{ p.source_url }}" target="_blank">Èñã„Åè</a></td>
                    <td><a href="{{ url_for('product_detail', product_id=p.id) }}">Á∑®ÈõÜ</a></td>
                    <td class="hide-mobile">{{ p.updated_at }}</td>
                </tr>
                {% endfor %}
            </table>
        </div>

        <div class="pagination">
            {% if has_prev %}
            <a href="{{ url_for('index', page=page-1, site=selected_site, status=selected_status) }}">&laquo; Ââç</a>
            {% endif %}
            <span>{{ page }} / {{ total_pages }}</span>
            {% if has_next %}
            <a href="{{ url_for('index', page=page+1, site=selected_site, status=selected_status) }}">Ê¨° &raquo;</a>
            {% endif %}
        </div>
    </form>
{% endblock %}

{% block scripts %}
    <script>
        function updateProfitMargin() {
            const markupInput = document.getElementById('markup');
            const profitMarginInput = document.getElementById('profit_margin');
            if (!markupInput || !profitMarginInput) return;
            const markup = parseFloat(markupInput.value);
            if (!isNaN(markup) && markup > 0) {
                const profitMargin = ((markup - 1) / markup) * 100;
                profitMarginInput.value = profitMargin.toFixed(0);
            } else {
                profitMarginInput.value = '';
            }
        }

        function updateMarkup() {
            const markupInput = document.getElementById('markup');
            const profitMarginInput = document.getElementById('profit_margin');
            if (!markupInput || !profitMarginInput) return;
            const profitMargin = parseFloat(profitMarginInput.value);
            if (!isNaN(profitMargin) && profitMargin < 100) {
                const markup = 1 / (1 - (profitMargin / 100));
                markupInput.value = markup.toFixed(2);
            } else {
                markupInput.value = '';
            }
        }

        function updateProfitMarginMobile() {
            const markupInput = document.getElementById('markup_mobile');
            const profitMarginInput = document.getElementById('profit_margin_mobile');
            if (!markupInput || !profitMarginInput) return;
            const markup = parseFloat(markupInput.value);
            if (!isNaN(markup) && markup > 0) {
                const profitMargin = ((markup - 1) / markup) * 100;
                profitMarginInput.value = profitMargin.toFixed(0);
            } else {
                profitMarginInput.value = '';
            }
        }

        function updateMarkupMobile() {
            const markupInput = document.getElementById('markup_mobile');
            const profitMarginInput = document.getElementById('profit_margin_mobile');
            if (!markupInput || !profitMarginInput) return;
            const profitMargin = parseFloat(profitMarginInput.value);
            if (!isNaN(profitMargin) && profitMargin < 100) {
                const markup = 1 / (1 - (profitMargin / 100));
                markupInput.value = markup.toFixed(2);
            } else {
                markupInput.value = '';
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            updateProfitMargin();
            updateProfitMarginMobile();
        });
    </script>
{% endblock %}