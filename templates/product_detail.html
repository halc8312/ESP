{% extends "base.html" %}

{% block title %}å•†å“ç·¨é›† - {{ product.last_title }}{% endblock %}
{% block header_title %}å•†å“ç·¨é›†{% endblock %}

{% block content %}
    <a href="{{ url_for('index') }}" class="back-link">&laquo; ä¸€è¦§ã«æˆ»ã‚‹</a>

    <div class="page-header">
        <h1>å•†å“ç·¨é›†</h1>
    </div>

    <form method="POST">
        <!-- å‰Šé™¤å¯¾è±¡IDãƒªã‚¹ãƒˆ -->
        <input type="hidden" name="delete_v_ids" id="delete_v_ids" value="">

        <!-- åŸºæœ¬æƒ…å ± -->
        <div class="content-card">
            <div class="content-card-header">
                <h2>åŸºæœ¬æƒ…å ±</h2>
            </div>
            <div class="content-card-body">
                <div class="form-group">
                    <label for="shop_id">æ‰€å±ã‚·ãƒ§ãƒƒãƒ—</label>
                    <select id="shop_id" name="shop_id">
                        <option value="">(å…±é€š / æœªæ‰€å±)</option>
                        {% for s in all_shops %}
                        <option value="{{ s.id }}" {% if product.shop_id==s.id %}selected{% endif %}>{{ s.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="title">å•†å“å (Title)</label>
                    <input type="text" id="title" name="title"
                        value="{{ product.custom_title or product.last_title or '' }}">
                </div>

                <div class="form-group">
                    <label for="status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ (Status)</label>
                    <select id="status" name="status">
                        <option value="active" {% if product.status=='active' %}selected{% endif %}>æœ‰åŠ¹ (Active)</option>
                        <option value="draft" {% if product.status=='draft' %}selected{% endif %}>ä¸‹æ›¸ã (Draft)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="template">èª¬æ˜æ–‡ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</label>
                    <select id="template" onchange="applyTemplate()">
                        <option value="">(ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠ)</option>
                        {% for t in templates %}
                        <option value="{{ t.content | e }}">{{ t.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="description">å•†å“èª¬æ˜ (Body HTML)</label>
                    <textarea id="description" name="description" rows="6">{{ product.custom_description or (snapshot.description if snapshot else '') }}</textarea>
                </div>
            </div>
        </div>

        <!-- ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š -->
        <div class="content-card">
            <div class="content-card-header">
                <h2>ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š</h2>
            </div>
            <div class="content-card-body">
                <!-- Bulk Generatorï¼ˆãƒ¢ãƒã‚¤ãƒ«ã§ã¯æŠ˜ã‚ŠãŸãŸã¿ï¼‰ -->
                <details class="mobile-collapsible" style="margin-bottom: 16px; background: #e3f2fd;">
                    <summary class="mobile-collapsible-header" style="background: #e3f2fd;">
                        <span class="mobile-collapsible-title">âš¡ ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ä¸€æ‹¬ç”Ÿæˆ</span>
                        <span class="mobile-collapsible-icon">â–¶</span>
                    </summary>
                    <div class="mobile-collapsible-content">
                        <p class="text-small text-muted mb-1">ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ (ä¾‹: S, M, L)ã€‚æ—¢å­˜ã®è¡Œã¯å‰Šé™¤ã•ã‚Œã¾ã›ã‚“ã€‚</p>
                        <div class="bulk-generator" style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
                            <div class="filter-group">
                                <label>Option1 Values</label>
                                <input type="text" id="bulk_opt1" placeholder="ä¾‹: Red, Blue">
                            </div>
                            <div class="filter-group">
                                <label>Option2 Values</label>
                                <input type="text" id="bulk_opt2" placeholder="ä¾‹: S, M, L">
                            </div>
                            <div class="filter-group">
                                <label>å…±é€šä¾¡æ ¼</label>
                                <input type="number" id="bulk_price" placeholder="">
                            </div>
                            <div class="filter-group">
                                <label>å…±é€šSKUæ¥é ­è¾</label>
                                <input type="text" id="bulk_sku" placeholder="MER-ITEM-">
                            </div>
                        </div>
                        <button type="button" onclick="generateVariants()" class="mt-1"
                            style="background:#0066cc; color:white; border:none; padding:10px 16px; border-radius:4px; cursor:pointer; width: 100%;">ç”Ÿæˆ</button>
                    </div>
                </details>

                <!-- ã‚ªãƒ—ã‚·ãƒ§ãƒ³åã®è¨­å®š -->
                <details class="mobile-collapsible mobile-only" style="margin-bottom: 16px;">
                    <summary class="mobile-collapsible-header">
                        <span class="mobile-collapsible-title">âš™ï¸ ã‚ªãƒ—ã‚·ãƒ§ãƒ³åè¨­å®š</span>
                        <span class="mobile-collapsible-icon">â–¶</span>
                    </summary>
                    <div class="mobile-collapsible-content">
                        <div class="filter-grid">
                            <div class="filter-group">
                                <label>Option1 Name</label>
                                <input type="text" name="option1_name" value="{{ product.option1_name or 'Title' }}">
                            </div>
                            <div class="filter-group">
                                <label>Option2 Name</label>
                                <input type="text" name="option2_name" value="{{ product.option2_name or '' }}" placeholder="(ä¾‹: Size)">
                            </div>
                            <div class="filter-group">
                                <label>Option3 Name</label>
                                <input type="text" name="option3_name" value="{{ product.option3_name or '' }}">
                            </div>
                        </div>
                    </div>
                </details>

                <!-- PCç”¨ã‚ªãƒ—ã‚·ãƒ§ãƒ³åè¨­å®š -->
                <div class="desktop-only" style="display:flex; gap:10px; margin-bottom:16px; background:#f0f0f0; padding:12px; border-radius: 6px;">
                    <div class="filter-group">
                        <label style="font-size:11px;">Option1 Name</label>
                        <input type="text" name="option1_name_desktop" value="{{ product.option1_name or 'Title' }}" style="width:120px;">
                    </div>
                    <div class="filter-group">
                        <label style="font-size:11px;">Option2 Name</label>
                        <input type="text" name="option2_name_desktop" value="{{ product.option2_name or '' }}" style="width:120px;" placeholder="(ä¾‹: Size)">
                    </div>
                    <div class="filter-group">
                        <label style="font-size:11px;">Option3 Name</label>
                        <input type="text" name="option3_name_desktop" value="{{ product.option3_name or '' }}" style="width:120px;">
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="variant-table" id="variantTable">
                        <thead>
                            <tr>
                                <th style="width:15%">Opt1</th>
                                <th style="width:15%">Opt2</th>
                                <th style="width:15%">ä¾¡æ ¼</th>
                                <th style="width:15%">SKU</th>
                                <th style="width:10%">åœ¨åº«</th>
                                <th class="hide-mobile" style="width:10%">é‡é‡</th>
                                <th class="hide-mobile">ç¨/HS/Origin</th>
                                <th style="width:50px;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for v in variants %}
                            <tr id="row-{{ v.id }}">
                                <td data-label="Opt1">
                                    <input type="hidden" name="v_ids" value="{{ v.id }}">
                                    <input type="text" name="v_opt1_{{ v.id }}" value="{{ v.option1_value or '' }}">
                                </td>
                                <td data-label="Opt2">
                                    <input type="text" name="v_opt2_{{ v.id }}" value="{{ v.option2_value or '' }}">
                                </td>
                                <td data-label="ä¾¡æ ¼">
                                    <input type="number" name="v_price_{{ v.id }}" value="{{ v.price or '' }}">
                                </td>
                                <td data-label="SKU">
                                    <input type="text" name="v_sku_{{ v.id }}" value="{{ v.sku or '' }}">
                                </td>
                                <td data-label="åœ¨åº«">
                                    <input type="number" name="v_qty_{{ v.id }}" value="{{ v.inventory_qty }}" class="short">
                                </td>
                                <td data-label="é‡é‡" class="hide-mobile">
                                    <input type="number" name="v_grams_{{ v.id }}" value="{{ v.grams or '' }}" class="short">
                                </td>
                                <td data-label="ç¨/HS/Origin" class="hide-mobile" style="text-align:left; font-size:11px;">
                                    <label><input type="checkbox" name="v_tax_{{ v.id }}" {% if v.taxable %}checked{% endif %}> èª²ç¨</label><br>
                                    HS: <input type="text" name="v_hs_{{ v.id }}" value="{{ v.hs_code or '' }}" style="width:60px;"><br>
                                    Org: <input type="text" name="v_org_{{ v.id }}" value="{{ v.country_of_origin or '' }}" style="width:40px;">
                                </td>
                                <td data-label="æ“ä½œ">
                                    <button type="button" class="del-btn" onclick="markDelete({{ v.id }})">å‰Šé™¤</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <button type="button" class="add-btn mt-1" onclick="addVariantRow()" style="width: 100%;">ï¼‹ ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ </button>
            </div>
        </div>

        <!-- åˆ†é¡ã¨SEOï¼ˆãƒ¢ãƒã‚¤ãƒ«ã§ã¯æŠ˜ã‚ŠãŸãŸã¿ï¼‰ -->
        <details class="mobile-collapsible mobile-only">
            <summary class="mobile-collapsible-header">
                <span class="mobile-collapsible-title">ğŸ“‚ åˆ†é¡ãƒ»SEOè¨­å®š</span>
                <span class="mobile-collapsible-icon">â–¶</span>
            </summary>
            <div class="mobile-collapsible-content">
                <div class="form-group">
                    <label for="vendor_mobile">è²©å£²å…ƒ (Vendor)</label>
                    <input type="text" id="vendor_mobile" name="vendor"
                        value="{{ product.custom_vendor or product.site or '' }}">
                </div>
                <div class="form-group">
                    <label for="tags_mobile">ã‚¿ã‚° (Tags)</label>
                    <input type="text" id="tags_mobile" name="tags" value="{{ product.tags or '' }}" placeholder="ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›">
                </div>
                <div class="form-group">
                    <label for="handle_mobile">URLãƒãƒ³ãƒ‰ãƒ« (Handle)</label>
                    <input type="text" id="handle_mobile" name="handle"
                        value="{{ product.custom_handle or ('mercari-' + product.id|string) }}">
                </div>
                <div class="form-group">
                    <label for="seo_title_mobile">ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ« (SEO Title)</label>
                    <input type="text" id="seo_title_mobile" name="seo_title" value="{{ product.seo_title or '' }}"
                        placeholder="60æ–‡å­—ä»¥å†…æ¨å¥¨">
                </div>
                <div class="form-group">
                    <label for="seo_description_mobile">ãƒ¡ã‚¿ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³</label>
                    <textarea id="seo_description_mobile" name="seo_description" rows="3">{{ product.seo_description or '' }}</textarea>
                </div>
            </div>
        </details>

        <!-- PCç”¨ï¼šåˆ†é¡ã¨SEO -->
        <div class="form-grid desktop-only">
            <div class="content-card">
                <div class="content-card-header">
                    <h2>åˆ†é¡</h2>
                </div>
                <div class="content-card-body">
                    <div class="form-group">
                        <label for="vendor">è²©å£²å…ƒ (Vendor)</label>
                        <input type="text" id="vendor" name="vendor_desktop"
                            value="{{ product.custom_vendor or product.site or '' }}">
                    </div>
                    <div class="form-group">
                        <label for="tags">ã‚¿ã‚° (Tags)</label>
                        <input type="text" id="tags" name="tags_desktop" value="{{ product.tags or '' }}" placeholder="ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›">
                    </div>
                </div>
            </div>

            <div class="content-card">
                <div class="content-card-header">
                    <h2>SEO</h2>
                </div>
                <div class="content-card-body">
                    <div class="form-group">
                        <label for="handle">URLãƒãƒ³ãƒ‰ãƒ« (Handle)</label>
                        <input type="text" id="handle" name="handle_desktop"
                            value="{{ product.custom_handle or ('mercari-' + product.id|string) }}">
                    </div>
                    <div class="form-group">
                        <label for="seo_title">ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ« (SEO Title)</label>
                        <input type="text" id="seo_title" name="seo_title_desktop" value="{{ product.seo_title or '' }}"
                            placeholder="60æ–‡å­—ä»¥å†…æ¨å¥¨">
                    </div>
                    <div class="form-group">
                        <label for="seo_description">ãƒ¡ã‚¿ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³</label>
                        <textarea id="seo_description" name="seo_description_desktop" rows="3">{{ product.seo_description or '' }}</textarea>
                    </div>
                </div>
            </div>
        </div>

        <div style="margin-top: 20px;">
            <button type="submit" style="width: 100%;">ä¿å­˜</button>
        </div>
    </form>

    <!-- ç”»åƒã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="content-card mt-2">
        <div class="content-card-header">
            <h2>ç”»åƒï¼ˆ{{ images|length }}æšï¼‰</h2>
        </div>
        <div class="content-card-body">
            {% if images %}
            <div class="images">
                {% for url in images %}
                <img src="{{ url }}" alt="image {{ loop.index }}">
                {% endfor %}
            </div>
            {% else %}
            <p class="text-muted">(ç”»åƒãªã—)</p>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        function applyTemplate() {
            var select = document.getElementById('template');
            var content = select.value;
            if (content) {
                document.getElementById('description').value = content;
            }
        }

        // å‰Šé™¤å¯¾è±¡IDã‚’ä¿æŒã™ã‚‹ãƒªã‚¹ãƒˆ
        var deleteIds = [];

        function markDelete(id) {
            if (confirm('ã“ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆä¿å­˜æ™‚ã«åæ˜ ã•ã‚Œã¾ã™ï¼‰')) {
                deleteIds.push(id);
                document.getElementById('delete_v_ids').value = deleteIds.join(',');
                document.getElementById('row-' + id).style.display = 'none';
                document.getElementById('row-' + id).classList.add('deleted-row');
            }
        }

        var newIndex = 0;

        function addVariantRow(opt1 = '', opt2 = '', price = '', sku = '') {
            newIndex++;
            var idx = newIndex;
            var table = document.getElementById('variantTable').getElementsByTagName('tbody')[0];
            var newRow = table.insertRow();

            newRow.innerHTML = `
                <td data-label="Opt1">
                    <input type="hidden" name="new_v_indices" value="${idx}">
                    <input type="text" name="new_v_opt1_${idx}" value="${opt1}">
                </td>
                <td data-label="Opt2">
                    <input type="text" name="new_v_opt2_${idx}" value="${opt2}">
                </td>
                <td data-label="ä¾¡æ ¼">
                    <input type="number" name="new_v_price_${idx}" value="${price}">
                </td>
                <td data-label="SKU">
                    <input type="text" name="new_v_sku_${idx}" value="${sku}">
                </td>
                <td data-label="åœ¨åº«">
                    <input type="number" name="new_v_qty_${idx}" value="1" class="short">
                </td>
                <td data-label="é‡é‡" class="hide-mobile">
                    <input type="number" name="new_v_grams_${idx}" value="" class="short">
                </td>
                <td data-label="ç¨/HS/Origin" class="hide-mobile" style="text-align:left; font-size:11px;">
                    <label><input type="checkbox" name="new_v_tax_${idx}"> èª²ç¨</label><br>
                    HS: <input type="text" name="new_v_hs_${idx}" value="" style="width:60px;"><br>
                    Org: <input type="text" name="new_v_org_${idx}" value="JP" style="width:40px;">
                </td>
                <td data-label="æ“ä½œ">
                    <button type="button" class="del-btn" onclick="removeNewRow(this)">å–æ¶ˆ</button>
                </td>
            `;
        }

        function removeNewRow(btn) {
            var row = btn.parentNode.parentNode;
            row.parentNode.removeChild(row);
        }

        function generateVariants() {
            const opt1Input = document.getElementById('bulk_opt1').value;
            const opt2Input = document.getElementById('bulk_opt2').value;
            const price = document.getElementById('bulk_price').value;
            const skuPrefix = document.getElementById('bulk_sku').value;

            const opt1Values = opt1Input.split(',').map(s => s.trim()).filter(s => s);
            const opt2Values = opt2Input.split(',').map(s => s.trim()).filter(s => s);

            if (opt1Values.length === 0) {
                alert('Option1 Valuesã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // If opt2 empty, just loop opt1
            if (opt2Values.length === 0) {
                opt1Values.forEach(v1 => {
                    let sku = skuPrefix ? skuPrefix + v1 : '';
                    addVariantRow(v1, '', price, sku);
                });
            } else {
                opt1Values.forEach(v1 => {
                    opt2Values.forEach(v2 => {
                        let sku = skuPrefix ? skuPrefix + v1 + '-' + v2 : '';
                        addVariantRow(v1, v2, price, sku);
                    });
                });
            }
        }
    </script>
{% endblock %}