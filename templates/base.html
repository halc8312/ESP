<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <title>{% block title %}ESP{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    {% block head %}{% endblock %}
</head>

<body class="{% block body_class %}has-bottom-nav{% endblock %}">
    <a class="skip-link" href="#main-content">æœ¬æ–‡ã¸ã‚¹ã‚­ãƒƒãƒ—</a>
    {% set current_shop = namespace(name='æœªé¸æŠ') %}
    {% for s in all_shops %}
    {% if current_shop_id == s.id %}
    {% set current_shop.name = s.name %}
    {% endif %}
    {% endfor %}
    <!-- Mobile Header with Hamburger -->
    <header class="mobile-header">
        <button class="hamburger-btn" data-action="toggle-sidebar" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã" aria-controls="sidebar"
            aria-expanded="false">
            <span class="hamburger-icon"></span>
        </button>
        <h1 class="mobile-header-title">{% block header_title %}ESP{% endblock %}</h1>
        <div class="mobile-header-shop">
            <form action="{{ url_for('set_current_shop') }}" method="post" class="shop-select-form">
                <label class="shop-select-label visually-hidden" for="mobile-shop-select">ã‚·ãƒ§ãƒƒãƒ—é¸æŠ</label>
                <select name="shop_id" id="mobile-shop-select" class="shop-select-compact" aria-describedby="shop-current"
                    data-auto-submit="true">
                    <option value="">æœªé¸æŠ</option>
                    {% for s in all_shops %}
                    <option value="{{ s.id }}" {% if current_shop_id==s.id %}selected{% endif %}>
                        {{ s.name[:8] }}{% if s.name|length > 8 %}...{% endif %}
                    </option>
                    {% endfor %}
                </select>
            </form>
            <span class="shop-current" id="shop-current">ç¾åœ¨: {{ current_shop.name }}</span>
        </div>
    </header>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" data-action="close-sidebar"></div>

    <!-- Sidebar Navigation (Mobile: slide-in drawer, PC: always visible) -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <span class="sidebar-logo">ESP</span>
            <button class="sidebar-close" data-action="close-sidebar" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹">Ã—</button>
        </div>
        <nav class="sidebar-nav">
            <a href="{{ url_for('index') }}" class="sidebar-link {% if request.endpoint == 'index' %}active{% endif %}"
                {% if request.endpoint == 'index' %}aria-current="page"{% endif %}>
                <span class="nav-icon">ğŸ“¦</span>
                <span class="nav-text">å•†å“ä¸€è¦§</span>
            </a>
            <a href="{{ url_for('dashboard') }}"
                class="sidebar-link {% if request.endpoint == 'dashboard' %}active{% endif %}" {% if request.endpoint
                == 'dashboard' %}aria-current="page"{% endif %}>
                <span class="nav-icon">ğŸ“Š</span>
                <span class="nav-text">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
            </a>
            <a href="{{ url_for('scrape_form') }}"
                class="sidebar-link {% if request.endpoint == 'scrape_form' %}active{% endif %}"
                {% if request.endpoint == 'scrape_form' %}aria-current="page"{% endif %}>
                <span class="nav-icon">ğŸ”</span>
                <span class="nav-text">ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°</span>
            </a>
            <a href="{{ url_for('manage_templates') }}"
                class="sidebar-link {% if request.endpoint == 'manage_templates' %}active{% endif %}"
                {% if request.endpoint == 'manage_templates' %}aria-current="page"{% endif %}>
                <span class="nav-icon">ğŸ“</span>
                <span class="nav-text">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</span>
            </a>
            <a href="{{ url_for('manage_shops') }}"
                class="sidebar-link {% if request.endpoint == 'manage_shops' %}active{% endif %}"
                {% if request.endpoint == 'manage_shops' %}aria-current="page"{% endif %}>
                <span class="nav-icon">ğŸª</span>
                <span class="nav-text">ã‚·ãƒ§ãƒƒãƒ—ç®¡ç†</span>
            </a>
            <a href="{{ url_for('pricing.pricing_list') }}"
                class="sidebar-link {% if request.endpoint == 'pricing.pricing_list' %}active{% endif %}"
                {% if request.endpoint == 'pricing.pricing_list' %}aria-current="page"{% endif %}>
                <span class="nav-icon">ğŸ’°</span>
                <span class="nav-text">ä¾¡æ ¼ãƒ«ãƒ¼ãƒ«</span>
            </a>
            <a href="{{ url_for('settings.settings_list') }}"
                class="sidebar-link {% if request.endpoint == 'settings.settings_list' %}active{% endif %}"
                {% if request.endpoint == 'settings.settings_list' %}aria-current="page"{% endif %}>
                <span class="nav-icon">âš™ï¸</span>
                <span class="nav-text">è¨­å®š</span>
            </a>
            <a href="{{ url_for('import.import_form') }}"
                class="sidebar-link {% if request.endpoint == 'import.import_form' %}active{% endif %}"
                {% if request.endpoint == 'import.import_form' %}aria-current="page"{% endif %}>
                <span class="nav-icon">ğŸ“¥</span>
                <span class="nav-text">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</span>
            </a>
            <a href="{{ url_for('archive.archive_list') }}"
                class="sidebar-link {% if request.endpoint == 'archive.archive_list' %}active{% endif %}"
                {% if request.endpoint == 'archive.archive_list' %}aria-current="page"{% endif %}>
                <span class="nav-icon">ğŸ“¦</span>
                <span class="nav-text">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</span>
            </a>
            <a href="{{ url_for('trash.trash_list') }}"
                class="sidebar-link {% if request.endpoint == 'trash.trash_list' %}active{% endif %}"
                {% if request.endpoint == 'trash.trash_list' %}aria-current="page"{% endif %}>
                <span class="nav-icon">ğŸ—‘ï¸</span>
                <span class="nav-text">ã‚´ãƒŸç®±</span>
            </a>
        </nav>


        <div class="sidebar-shop-section">
            <label class="sidebar-shop-label">ã‚·ãƒ§ãƒƒãƒ—é¸æŠ</label>
            <form action="{{ url_for('set_current_shop') }}" method="post" class="shop-select-form">
                <select name="shop_id" class="sidebar-shop-select">
                    <option value="">(ã‚·ãƒ§ãƒƒãƒ—æœªé¸æŠ)</option>
                    {% for s in all_shops %}
                    <option value="{{ s.id }}" {% if current_shop_id==s.id %}selected{% endif %}>
                        {{ s.name }}
                    </option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-compact">é©ç”¨</button>
            </form>
            <span class="shop-current">ç¾åœ¨: {{ current_shop.name }}</span>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content" id="main-content">
        {% block content %}{% endblock %}
    </main>

    <!-- Bottom Navigation (Mobile only) -->
    <nav class="bottom-nav">
        <a href="{{ url_for('index') }}" class="bottom-nav-item {% if request.endpoint == 'index' %}active{% endif %}"
            {% if request.endpoint == 'index' %}aria-current="page"{% endif %}>
            <span class="bottom-nav-icon">ğŸ“¦</span>
            <span class="bottom-nav-label">å•†å“</span>
        </a>
        <a href="{{ url_for('dashboard') }}"
            class="bottom-nav-item {% if request.endpoint == 'dashboard' %}active{% endif %}"
            {% if request.endpoint == 'dashboard' %}aria-current="page"{% endif %}>
            <span class="bottom-nav-icon">ğŸ“Š</span>
            <span class="bottom-nav-label">ãƒ€ãƒƒã‚·ãƒ¥</span>
        </a>
        <a href="{{ url_for('scrape_form') }}"
            class="bottom-nav-item {% if request.endpoint == 'scrape_form' %}active{% endif %}"
            {% if request.endpoint == 'scrape_form' %}aria-current="page"{% endif %}>
            <span class="bottom-nav-icon">ğŸ”</span>
            <span class="bottom-nav-label">å–å¾—</span>
        </a>
        <a href="{{ url_for('manage_templates') }}"
            class="bottom-nav-item {% if request.endpoint == 'manage_templates' %}active{% endif %}"
            {% if request.endpoint == 'manage_templates' %}aria-current="page"{% endif %}>
            <span class="bottom-nav-icon">ğŸ“</span>
            <span class="bottom-nav-label">ãƒ†ãƒ³ãƒ—ãƒ¬</span>
        </a>
        <a href="{{ url_for('manage_shops') }}"
            class="bottom-nav-item {% if request.endpoint == 'manage_shops' %}active{% endif %}"
            {% if request.endpoint == 'manage_shops' %}aria-current="page"{% endif %}>
            <span class="bottom-nav-icon">ğŸª</span>
            <span class="bottom-nav-label">åº—èˆ—</span>
        </a>
    </nav>

    <!-- Back to Top Button -->
    <button class="back-to-top" id="backToTop" type="button">â†‘</button>

    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            const toggleButton = document.querySelector('[data-action="toggle-sidebar"]');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('open');
            document.body.classList.toggle('sidebar-open');
            if (toggleButton) {
                toggleButton.setAttribute('aria-expanded', sidebar.classList.contains('open'));
            }
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            const toggleButton = document.querySelector('[data-action="toggle-sidebar"]');
            sidebar.classList.remove('open');
            overlay.classList.remove('open');
            document.body.classList.remove('sidebar-open');
            if (toggleButton) {
                toggleButton.setAttribute('aria-expanded', 'false');
            }
        }

        // Close sidebar on escape key
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeSidebar();
            }
        });

        // Close sidebar when clicking a link (mobile)
        document.querySelectorAll('.sidebar-link').forEach(function (link) {
            link.addEventListener('click', function () {
                if (window.innerWidth < 1024) {
                    closeSidebar();
                }
            });
        });

        document.querySelectorAll('[data-action="toggle-sidebar"]').forEach(function (button) {
            button.addEventListener('click', toggleSidebar);
        });

        document.querySelectorAll('[data-action="close-sidebar"]').forEach(function (button) {
            button.addEventListener('click', closeSidebar);
        });

        document.querySelectorAll('select[data-auto-submit="true"]').forEach(function (select) {
            select.addEventListener('change', function () {
                if (select.form) {
                    select.form.submit();
                }
            });
        });

        const backToTop = document.getElementById('backToTop');
        if (backToTop) {
            backToTop.addEventListener('click', function () {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }

        // Back to top button visibility
        window.addEventListener('scroll', function () {
            if (backToTop) {
                if (window.scrollY > 300) {
                    backToTop.classList.add('visible');
                } else {
                    backToTop.classList.remove('visible');
                }
            }
        });
    </script>
    {% block scripts %}{% endblock %}
</body>

</html>
