<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <title>ダッシュボード</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
    <div class="nav">
        <div>
            <a href="{{ url_for('index') }}">商品一覧</a>
            <a href="{{ url_for('dashboard') }}" class="active">ダッシュボード</a>
            <a href="{{ url_for('scrape_form') }}">新規スクレイピング</a>
            <a href="{{ url_for('manage_templates') }}">テンプレート</a>
            <a href="{{ url_for('manage_shops') }}">ショップ管理</a>
        </div>
        <div>
            <form action="{{ url_for('set_current_shop') }}" method="post" style="margin:0;">
                <select name="shop_id" onchange="this.form.submit()">
                    <option value="">(ショップ未選択)</option>
                    {% for s in all_shops %}
                    <option value="{{ s.id }}" {% if current_shop_id==s.id %}selected{% endif %}>
                        {{ s.name }}
                    </option>
                    {% endfor %}
                </select>
            </form>
        </div>
    </div>

    <h1>ダッシュボード</h1>

    <!-- KPI Cards -->
    <div class="dashboard-grid">
        <div class="stat-card">
            <h3>全商品数 ({{ current_shop_id and '選択中' or '全ショップ' }})</h3>
            <div class="value">{{ total_items }}</div>
        </div>
        <div class="stat-card">
            <h3>出品中 (Active)</h3>
            <div class="value" style="color: #2e7d32;">{{ status_map.get('active', 0) }}</div>
        </div>
        <div class="stat-card">
            <h3>在庫切れ (Variant=0)</h3>
            <div class="value" style="color: #c62828;">{{ sold_out_count }}</div>
        </div>
        <div class="stat-card">
            <h3>下書き (Draft)</h3>
            <div class="value" style="color: #f57f17;">{{ status_map.get('draft', 0) }}</div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="form-section" style="margin-top: 24px;">
        <h2>最近更新された商品</h2>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>画像</th>
                        <th>タイトル</th>
                        <th>価格</th>
                        <th>ステータス</th>
                        <th>最終更新</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in recent_items %}
                    <tr>
                        <td>
                            {% if p.snapshots and p.snapshots[0].image_urls %}
                            <img src="{{ p.snapshots[0].image_urls.split('|')[0] }}"
                                style="width: 50px; height: 50px; object-fit: cover;">
                            {% else %}
                            <span style="display:inline-block; width:50px; height:50px; background:#eee;"></span>
                            {% endif %}
                        </td>
                        <td>{{ p.custom_title or p.last_title }}</td>
                        <td>¥{{ "{:,}".format(p.last_price or 0) }}</td>
                        <td>{{ p.last_status }}</td>
                        <td>{{ p.updated_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            <a href="{{ url_for('product_detail', product_id=p.id) }}" class="btn">編集</a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" style="text-align:center;">更新履歴はありません</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div style="margin-top:10px; text-align:right;">
            <a href="{{ url_for('index') }}">すべて見る &raquo;</a>
        </div>
    </div>
</body>

</html>